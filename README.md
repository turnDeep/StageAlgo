# 株式ステージ分析ツール

## 概要

このプロジェクトは、Stan Weinstein（スタン・ワインスタイン）の市場ステージ分析理論に基づいた株式分析ツールです。指定された銘柄リスト（`stock.csv`）を読み込み、各銘柄が現在4つのステージ（1: 底固め、2: 上昇、3: 天井圏、4: 下降）のいずれにあるかを判定します。

さらに、ステージ間の移行の強さを客観的に評価するためのスコアリングシステムを実装しており、規律ある投資判断をサポートします。

## 主な機能

-   **ステージ分析**: 50日移動平均線の傾きや過去の価格帯に基づき、現在の市場ステージを自動で判定します。
-   **移行スコアリング**: 各ステージの移行（例: ステージ1→2）の可能性と質を0〜100のスコアで評価し、具体的なアクションプランを提示します。
-   **複数銘柄の一括分析**: `stock.csv` ファイルに記載されたティッカーシンボルをすべて読み込み、一括で分析を実行します。
-   **堅牢なデータ取得**: `yfinance` と `curl-cffi` を組み合わせ、Webスクレイピングのブロックを回避しながら安定的に株価データを取得します。
-   **高度なテクニカル指標**: トレンドの強さを正規化して比較可能にする「MA傾き」や、市場全体に対する個別株の強さを示す「RS Rating」など、カスタム指標を計算します。
-   **過去データ分析**: `historical_analyzer.py` を使用して、特定の銘柄の過去のステージ移行履歴を分析することも可能です。

## 実行方法

本ツールは、ローカル環境またはDocker環境で実行できます。

### A) ローカル環境での実行

ローカルで実行する場合、まず依存ライブラリをインストールする必要があります。

```bash
# 依存ライブラリのインストール
pip install -r requirements.txt

# ティッカーリストの生成
python get_tickers.py

# 分析の実行 (例: stage1or2.py)
python stage1or2.py
```

### B) Dockerを利用した実行

DockerとDocker Composeを利用すると、OSに依存しない簡単なコマンドで環境を構築し、各スクリプトを実行できます。

#### 1. スクリプトの実行
プロジェクトのルートディレクトリで、以下の`docker-compose run`コマンドを使用します。初回実行時に、必要なDockerイメージが自動的にビルドされます。

**ステップ1: ティッカーリストの準備**
`get_tickers.py` を実行し、分析対象のティッカーリスト `stock.csv` を生成します。
```bash
docker-compose run --rm app python get_tickers.py
```
このコマンドにより、`stock.csv` がカレントディレクトリに作成されます。

**ステップ2: ステージ分析の実行**
`stock.csv` を基に、各種分析スクリプトを実行します。

- **A) 有望な銘柄を抽出しCSVに出力**
  `stage1or2.py` を実行すると、分析結果が `stage1or2.csv` として保存されます。
  ```bash
  docker-compose run --rm app python stage1or2.py
  ```

- **B) 全銘柄の最新ステージを分析**
  `main.py` は、全銘柄の分析結果をコンソールに直接出力します。
  ```bash
  docker-compose run --rm app python main.py
  ```

**ステップ3: 個別銘柄の過去分析 (オプション)**
`historical_analyzer.py` を使って、特定の銘柄（例: AAPL）の過去のステージ移行履歴を分析します。
```bash
docker-compose run --rm app python historical_analyzer.py AAPL
```

#### 2. コンテナへのアクセス (オプション)
コンテナをバックグラウンドで起動し、中に入って作業することもできます。
```bash
# コンテナをバックグラウンドで起動
docker-compose up -d

# 起動したコンテナ内でbashを起動
docker-compose exec app bash
```

## プロジェクト構造

```
.
├── Dockerfile                # Docker環境を定義
├── main.py                   # 全銘柄の最新ステージを分析
├── stage1or2.py              # ステージ1, 2の有望銘柄を抽出しCSV出力
├── get_tickers.py            # NASDAQ/NYSEのティッカーを取得しstock.csvを生成
├── historical_analyzer.py    # 個別銘柄の過去のステージ移行を分析
├── stock.csv                 # 分析対象のティッカーリスト
├── data_fetcher.py           # 株価データ取得モジュール
├── indicators.py             # テクニカル指標計算モジュール
├── stage_engine.py           # ステージ判定ロジックのコアモジュール
├── requirements.txt          # 依存ライブラリ
└── README.md                 # このファイル
```

## 分析ロジック詳細

### 第1部：現在のステージ判定ロジック

本システムは、まず50日移動平均線（MA50）の傾きと、過去の価格帯における現在価格の位置に基づいて、現在のステージを総合的に判断します。

1.  **ステージ4 (下降期)**: MA50の傾きが明確な下降トレンドを示している場合。
2.  **ステージ2 (上昇期)**: MA50の傾きが明確な上昇トレンドにあり、かつステージ1→2への移行スコアがB判定（70点）以上の場合。これにより、弱い上昇シグナルを除外します。
3.  **ステージ1 (底固め期) / ステージ3 (天井圏)**: 上記以外の場合（MA50が横ばい、または上昇が弱い場合）、過去の高値からの下落率に基づいて判断します。
    -   過去1年間の高値から大きく下落している場合は、**ステージ1**と見なします。
    -   過去150日間の高値圏で推移している場合は、**ステージ3**と見なします。

### 第2部：ステージ移行スコアリング

#### 1. ステージ1 → 2【上昇期への移行】

**目的**: 本格的な上昇トレンドの始まり（ブレイクアウト）を捉え、最適なエントリーポイントを特定します。

| カテゴリ | 評価項目 | 配点 |
|:---|:---|:---|
| 出来高 | ブレイクアウト時の出来高急増 | 25点 |
| 価格 | 50日高値からのブレイクアウト | 10点 |
| トレンド | MA50のゴールデンクロスと傾き | 15点 |
| 相対強度 | RS Ratingの強さ | 15点 |
| ボラティリティ | ATRを用いたトレンド初動の検知 | 15点 |
| 市場環境 | ベンチマーク(SPY)の全体相場 | 20点 |
| **合計** | | **100点** |

| 判定 | 条件 | 推奨アクション |
|:---|:---|:---|
| A判定 | スコア85点以上 + 確認済み | 自信を持ってエントリーを検討すべき理想的なシグナル。 |
| B判定 | スコア70点以上 + 確認済み | エントリーを検討。リスク管理を推奨。 |
| C判定 | 上記以外 | エントリーは見送り。スコアが高くても未確認なら「確認待ち」。 |

#### 2. ステージ2 → 3【天井圏への移行】

**目的**: 上昇トレンドの勢いの衰えと、大口投資家による利益確定売り（Distribution）の兆候を捉えます。

| カテゴリ | 評価項目 | 配点 |
|:---|:---|:---|
| 過熱感 | ATRを用いたMAからの乖離 | 30点 |
| 大口の売り | 下落日の出来高増 (Distribution Day) | 25点 |
| 反転サイン | 長い上ヒゲの出現 | 20点 |
| トレンド鈍化 | MA50の傾きの平坦化 | 15点 |
| 相対強度 | RS Ratingの低下傾向 | 10点 |
| **合計** | | **100点** |

| スコア | 判定 | 推奨アクション |
|:---|:---|:---|
| 75点以上 | 危険 | ポジションの大部分の利益確定を強く推奨。 |
| 50-74点 | 警告 | 新規の買いは見送り、一部を利益確定。 |
| 50点未満 | 安全 | ポジションを維持し、トレンド継続を期待。 |

#### 3. ステージ3 → 4【下降期への移行】

**目的**: レンジ相場の終焉と、本格的な下降トレンドへの突入（ブレイクダウン）を特定します。

| 評価項目 | 配点 |
|:---|:---|
| 過去50日間の最安値を更新 | 30点 |
| 出来高を伴うブレイクダウン | 30点 |
| MA50が下降トレンドに転換 | 25点 |
| RS Ratingが40以下に低迷 | 15点 |
| **合計** | **100点** |

| スコア | 判定 | 推奨アクション |
|:---|:---|:---|
| 75点以上 | 危険 | 全ポジションを決済し、損失を限定する。 |
| 75点未満 | 警告 | 保有は避け、ブレイクダウンに最大限警戒する。 |

#### 4. ステージ4 → 1【底固め期への移行】

**目的**: 下降トレンドが終了し、次の上昇サイクルに向けたエネルギーを溜める期間に入ったことを判定します。

| 評価項目 | 配点 |
|:---|:---|
| MA50の傾きが横ばいになり、新安値をつけなくなる | 35点 |
| 出来高が減少し、売りが枯渇する | 30点 |
| 価格のボラティリティが低下する | 20点 |
| RS Ratingが底を打ち、上昇に転じる | 15点 |
| **合計** | **100点** |

| スコア | 判定 | 推奨アクション |
|:---|:---|:---|
| 70点以上 | 底打ち完了 | 監視リストに追加し、将来のステージ2移行を待つ。 |
| 70点未満 | 下降継続 | 底打ちの条件は未達。引き続き手を出さない。 |